# G1机器人定位部署

### 机器人网络设置

   
​	首先可以按照 [宇树科技 文档中心](https://support.unitree.com/home/zh/G1_developer/FAQ) 的方法2 方法3 进行设置。

​	不行的话，使用 ```nmtui``` 进行手动设置连接

​	如果提示 ```rfkill``` 相关，查看设备是否被禁用 ``` rfkill list``` ，解除软禁用 ``` sudo rfkill unblock wifi ``` 

### 对应仓库

 [deepglint/FAST_LIO_LOCALIZATION_HUMANOID: Localization by LiDAR for Humanoid(like Unitree G1)](https://github.com/deepglint/FAST_LIO_LOCALIZATION_HUMANOID/tree/main)

## 1. 安装依赖库

```shell
sudo apt install libc++-dev libc++abi-dev
sudo apt-get install libeigen3-dev
```

## 2. 安装 Livox SDK 和 ROS 驱动

- [Livox SDK](https://github.com/Livox-SDK/Livox-SDK)
- [Livox-SDK2](https://github.com/Livox-SDK/Livox-SDK2)
- [Livox_ROS_Driver](https://github.com/Livox-SDK/livox_ros_driver)
- **Livox_ROS_Driver2 直接使用库里提供的修改过的版本，不用手动安装**

## 3. 安装 Open3D

​	仓库给的 Open3D 在 arm64 上无法使用，需要自己手动编译。

- 安装 cmake 3.24

​	在 [cmake 官方](https://cmake.org/files/v3.24/) 下载 cmake 3.24.4 原代码 

​	```sudo wget https://cmake.org/files/v3.24/cmake-3.24.4.tar.gz```

​	按照 [ ubuntu 20.04安装(升级)cmake - 知乎](https://zhuanlan.zhihu.com/p/519732843) 安装
​	make 时最好不要使用 ```-j8``` 容易将所有线程占完，导致机器人难以访问

- 安装 Open3D

​	直接按照 [人形-基于宇树g1的自主导航定位 - 知乎](https://zhuanlan.zhihu.com/p/1930013063890843555) 安装最新版本的 Open3D 即可

```shell
#open3D build from source 
git clone https://github.com/isl-org/Open3D
# Only needed for Ubuntu
util/install_deps_ubuntu.sh
mkdir build
cd build

# 此处重要，不如此做会产生报错
cmake .. \
  -DUSE_SYSTEM_CURL=ON \
  -DBUILD_SHARED_LIBS=ON
  
# On Ubuntu
make -j6
sudo make install
```

## 4. 安装[FAST_LIO_LOCALIZATION_HUMANOID](https://github.com/deepglint/FAST_LIO_LOCALIZATION_HUMANOID)

​	按照 README 构建好工作空间并完成下载

- 编译

​	因为已经手动安装过 Open3D ，需要在open3d_loc/CMakeLists.txt文件里注释掉set(Open3D_DIR "/home/liar/open3d141/lib/cmake/Open3D")

​	**！！！！！编译前需要source Livox-ROS-Driver！！！！！！**

​	``` source livox_ros_driver/devel/setup.bash```

​	新版本的 Open3D 有接口变动，所以需要修改cpp代码，具体如下：

​	**头文件 ```open3d_registration.h``` 中加入**

```
#include <optional>
```

​	替换改动
```
open3d::utility::optional<unsigned int> 替换为 std::optional<unsigned int>
open3d::utility::nullopt 替换为 std::nullopt
```

​	**对应的```open3d_registration.cpp``` 中加入**

```
#include <optional>
```


​	替换改动

```
open3d::utility::optional<unsigned int> 替换为 std::optional<unsigned int>
seed_ = open3d::utility::nullopt; 替换为 seed_ = std::nullopt;
```

​	删除改动，删除最后的seed_

```
RegistrationRANSACBasedOnFeatureMatching(
    *source, *target, *source_fpfh, *target_fpfh,
    mutual_filter, distance_threshold,
    open3d::pipelines::registration::
        TransformationEstimationPointToPoint(false),
    4 /*最小3*/, correspondence_checker,
    open3d::pipelines::registration::RANSACConvergenceCriteria(1000000, 0.999), seed_);
改为
RegistrationRANSACBasedOnFeatureMatching(
    *source, *target, *source_fpfh, *target_fpfh,
    mutual_filter, distance_threshold,
    open3d::pipelines::registration::
        TransformationEstimationPointToPoint(false),
    4 /*最小3*/, correspondence_checker,
    open3d::pipelines::registration::RANSACConvergenceCriteria(1000000, 0.999));
```

## 5. 启动 MID360 雷达

使用 ```ip a``` 查看机器人本机的 IP

例如：```eth0: 192.168.123.164```

修改 ```livox_ros_driver2/config/MID360_config.json```

```
"host_net_info" : {
  "cmd_data_ip" : "192.168.123.164",
  "push_msg_ip": "192.168.123.164",
  "point_data_ip": "192.168.123.164",
  "imu_data_ip" : "192.168.123.164"
}
```

启动雷达：

```
roslaunch livox_ros_driver2 msg_MID360.launch
```

## 6. 启动建图

修改 ``` FAST_LIO_LOCALIZATION_HUMANOID/FAST_LIO/config/mid360_g1.yaml``` 中的 ```pcd_save_en``` 为true

修改 ``` FAST_LIO_LOCALIZATION_HUMANOID/FAST_LIO/launch/mapping_mid360_g1.yaml``` 中的 ```rviz``` 为true来查看实时建图效果

启动建图：

```
source devel/setup.bash
roslaunch fast_lio mapping_mid360_g1.launch
```

ctrl + c 后，会将地图保存在 ``` FAST_LIO_LOCALIZATION_HUMANOID/FAST_LIO/PCD/scans.pcd ```

## 7. 启动定位

修改 ``` FAST_LIO_LOCALIZATION_HUMANOID/FAST_LIO/config/mid360_g1.yaml``` 中的 ```pcd_save_en``` 为false

修改 ``` FAST_LIO_LOCALIZATION_HUMANOID/FAST_LIO/launch/mapping_mid360_g1.yaml``` 中的 ```rviz``` 为false

修改 ```FAST_LIO_LOCALIZATION_HUMANOID/open3d_loc/launch/open3d_loc_g1.launch``` 中的 ```<param name="path_map" type="string" value="$(find open3d_loc)/../data/map.ply" />``` 地址大概为 ``` find open3d_loc)/../FAST_LIO/PCD/scans.pcd```

启动定位

```
source devel/setup.bash
roslaunch open3d_loc localization_3d_g1.launch
```

## 自动化脚本


自动化脚本默认 ```livox_ros_driver``` 安装在 ```FAST_LIO_LOCALIZATION_HUMANOID``` 的上两个目录，即：
```
g1_ws
|----loc
|     |----src
|     |     |----FAST_LIO_LOCALIZATION_HUMANOID
|
|----livox_ros_driver
|           |----src
|           |----devel
```

**首先需要将自动化脚本移动至g1_ws下**
```
mv *.sh ../../../
```

### 1. 启动 ROS1
```
roscore
```
### 2. 启动雷达
```
# 创建一个新终端
cd g1_ws
bash start_lidar.sh
```
### 3. 启动建图
```
# 创建一个新终端
cd g1_ws
bash start_mapping.sh
```
### 4.启动定位
```
# 创建一个新终端
cd g1_ws
bash start_loc.sh
```



